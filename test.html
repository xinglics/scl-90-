<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script>
    // 进阶安全检查
    const startTime = localStorage.getItem('scl90_start_time');
    const now = new Date().getTime();
    
    // 1. 检查是否有开始时间
    if (!startTime) {
        alert("非法访问！请先登录。");
        window.location.href = 'index.html';
    } 
    // 2. 检查是否超过 24 小时 (24 * 60 * 60 * 1000 毫秒)
    else if (now - parseInt(startTime) > 86400000) {
        alert("您的测试授权已过期 (24小时)，请重新购买。");
        localStorage.removeItem('scl90_active_code'); // 清除过期的码
        localStorage.removeItem('scl90_start_time');
        window.location.href = 'index.html';
    }
    // 3. 这里的 sessionStorage 是为了防止用户直接复制网址打开，必须经过 index 页面的跳转
    else if (!sessionStorage.getItem('isAuthorized') && !localStorage.getItem('scl90_active_code')) {
         window.location.href = 'index.html';
    }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCL-90 症状自评量表 </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        header {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 { margin: 0; color: #2c3e50; }
        .subtitle { color: #7f8c8d; font-size: 0.9em; margin-top: 10px; }

        .scale-guide {
            background: #eef2f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-size: 0.95em;
            border-left: 5px solid var(--primary-color);
        }

        .question-item {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .question-item:hover { background-color: #f9f9f9; }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
        }

        .options-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .options-group label {
            flex: 1;
            min-width: 80px;
            text-align: center;
            background: #fff;
            border: 1px solid #ddd;
            padding: 8px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .options-group label:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .options-group input { display: none; }
        .options-group input:checked + span { font-weight: bold; }
        .options-group label:has(input:checked) {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-area { text-align: center; margin-top: 40px; }
        
        button.btn-submit {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,86,179,0.3);
            transition: transform 0.1s;
        }
        button.btn-submit:active { transform: scale(0.98); }

        /* 结果区域 */
        #result-section { display: none; margin-top: 40px; border-top: 2px solid #eee; padding-top: 40px; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        @media (max-width: 768px) {
            .result-grid { grid-template-columns: 1fr; }
            .container { padding: 20px; }
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background-color: #f8f9fa; }
        .warn { color: #e74c3c; font-weight: bold; }
        
        .disclaimer {
            margin-top: 50px;
            font-size: 0.8em;
            color: #999;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>SCL-90 症状自评量表</h1>
        <p class="subtitle">请根据您最近一周的实际感受进行评分</p>
    </header>

    <div class="scale-guide">
        <strong>评分标准：</strong>
        1-没有 (自觉无该项症状) &nbsp;|&nbsp; 
        2-很轻 (自觉有该项症状，但对您无实际影响) &nbsp;|&nbsp; 
        3-中等 (自觉有该项症状，对您有一定影响) &nbsp;|&nbsp; 
        4-偏重 (自觉常有该项症状，对您有相当程度的影响) &nbsp;|&nbsp; 
        5-严重 (自觉该症状的频度和强度都十分严重)
    </div>

    <form id="scl90-form"></form>

    <div class="action-area">
        <button type="button" class="btn-submit" onclick="submitTest()">提交测试</button>
    </div>

    <div id="result-section">
        <h2 style="text-align: center; color: #2c3e50;">测试报告</h2>
        
        <div class="result-grid">
            <div>
                <h3>数据概览</h3>
                <div id="score-summary"></div>
                <table>
                    <thead>
                        <tr>
                            <th>因子</th>
                            <th>得分</th>
                            <th>参考状态</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body"></tbody>
                </table>
            </div>
            <div>
                <h3>因子分布图</h3>
                <canvas id="radarChart"></canvas>
            </div>
        </div>
        
        <div class="disclaimer">
            注意：本测试结果仅供自我参考，不具备医疗诊断效力。如果不适感强烈，请务必前往正规医院心理科或精神科就诊。
        </div>
    </div>
</div>

<script>
    // 完整的90道题目
    const questionsData = [
        "头痛", "神经过敏，心中不踏实", "头脑中有不必要的想法或字句反复出现", "头晕或心中乱糟糟的", "对异性的兴趣减退", 
        "对旁人怀有敌意", "觉得在公共场合吃东西很不舒服", "感到有人在背后议论你", "感到前途无望", "说话困难",
        "神情沮丧，灰心", "担心自己的衣饰整齐与否", "容易烦恼和激动", "感到手脚发抖", "对旁人缺乏同情心",
        "感到无法完成任务", "感到身体发酸，发痛", "感到事情不顺心", "感到人们对您不友好", "容易哭泣",
        "感到害羞，不自在", "感到受骗，中了圈套", "无缘无故地惊恐", "自己不能控制地大发脾气", "怕单独出门",
        "经常责怪自己", "腰痛", "感到难以完成任务", "感到孤独", "感到苦闷",
        "过分担忧", "对事物不感兴趣", "感到害怕", "您的感情容易受到伤害", "旁人能知道您的私下想法",
        "感到别人不理解您，不同情您", "感到人们对您不友好，不喜欢您", "做事必须做得很慢以保证做得正确", "心跳得很厉害", "恶心或胃部不舒服",
        "感到比不上别人", "肌肉酸痛", "感到有人在监视您", "难以入睡", "做事必须反复检查",
        "难以作出决定", "怕乘电车、公共汽车、地铁或火车", "呼吸有困难", "一阵阵发冷或发热", "因为感到害怕而避开某些东西、场合或活动",
        "脑子变空了", "身体发麻或刺痛", "喉咙有梗塞感", "感到没有前途", "不能集中注意力",
        "感到身体的某一部分软弱无力", "感到紧张或容易紧张", "感到手或脚发重", "想到死亡的事", "吃得太多",
        "当别人看着您或谈论您时感到不自在", "有一些不属于您自己的想法", "有想打人或伤害他人的冲动", "醒得太早", "必须反复洗手、点数目或触摸某些东西",
        "睡得不稳不深", "有想摔坏或破坏东西的冲动", "有一些别人没有的想法", "对旁人十分冷淡", "在商店或电影院等人多的地方感到不自在",
        "感到任何事情都很难做", "一阵阵恐惧或惊恐", "感到在公共场合吃东西很不舒服", "经常与人争论", "单独一人时神经很紧张",
        "别人对您的成绩没有作出恰当的评价", "即使和别人在一起也感到孤单", "感到坐立不安", "感到自己一无是处", "感到熟悉的东西变成陌生或不象是真的",
        "大叫或摔东西", "害怕要在公共场合昏倒", "感到别人想占您的便宜", "为一些有关性的念头而很苦恼", "您认为应该因为自己的过错而受到惩罚",
        "感到身体严重虚弱", "感到要很快把事情做完", "感到自己的身体有严重的毛病", "从无", "从无" // 修正：原SCL90最后两题为"从未有过"占位或特定版本，这里补全标准版最后两题
    ];
    // 修正最后两题为标准SCL-90各版本通用的：
    questionsData[88] = "感到对自己的罪恶深重";
    questionsData[89] = "认为自己的脑子有毛病";

    // 因子映射表 (题目序号-1，对应数组索引)
    const factors = {
        "躯体化": [0, 3, 11, 26, 39, 41, 47, 48, 51, 52, 55, 57],
        "强迫症状": [2, 8, 9, 27, 37, 44, 45, 50, 54, 64],
        "人际关系敏感": [5, 20, 33, 35, 36, 40, 60, 68, 72],
        "抑郁": [4, 13, 14, 19, 21, 25, 28, 29, 30, 31, 53, 70, 78],
        "焦虑": [1, 16, 22, 32, 38, 56, 71, 77, 79, 85],
        "敌对": [10, 23, 62, 66, 73, 80],
        "恐怖": [12, 24, 46, 49, 69, 74, 81],
        "偏执": [7, 17, 42, 67, 75, 82],
        "精神病性": [6, 15, 34, 61, 76, 83, 84, 86, 87, 89],
        "其他(睡眠/饮食)": [18, 43, 58, 59, 63, 65, 88]
    };

    // 渲染题目
    const form = document.getElementById('scl90-form');
    questionsData.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = 'question-item';
        // 为方便校验，ID设为 q1, q2...
        div.id = `q-row-${i+1}`;
        div.innerHTML = `
            <span class="question-text">${i + 1}. ${q}</span>
            <div class="options-group">
                <label><input type="radio" name="q${i+1}" value="1"> <span>1-没有</span></label>
                <label><input type="radio" name="q${i+1}" value="2"> <span>2-很轻</span></label>
                <label><input type="radio" name="q${i+1}" value="3"> <span>3-中等</span></label>
                <label><input type="radio" name="q${i+1}" value="4"> <span>4-偏重</span></label>
                <label><input type="radio" name="q${i+1}" value="5"> <span>5-严重</span></label>
            </div>
        `;
        form.appendChild(div);
    });

    // 提交逻辑
    function submitTest() {
        const scores = [];
        let firstUnanswered = null;

        // 校验是否全部答完
        for (let i = 1; i <= 90; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (!selected) {
                if (!firstUnanswered) firstUnanswered = i;
                document.getElementById(`q-row-${i}`).style.background = "#ffe6e6"; // 高亮未填项
            } else {
                document.getElementById(`q-row-${i}`).style.background = ""; // 恢复背景
                scores[i] = parseInt(selected.value);
            }
        }

        if (firstUnanswered) {
            alert(`您第 ${firstUnanswered} 题尚未作答，请完成后再提交。`);
            document.getElementById(`q-row-${firstUnanswered}`).scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }

        calculateAndShow(scores);
    }

   function calculateAndShow(scores) {
        // 1. 计算总分
        let totalScore = 0;
        for(let i=1; i<=90; i++) totalScore += scores[i];

        // 2. 计算各因子分
        let factorScores = {};
        for (const [name, indexes] of Object.entries(factors)) {
            let sum = 0;
            indexes.forEach(idx => sum += scores[idx + 1]);
            factorScores[name] = (sum / indexes.length).toFixed(2);
        }

        // 3. 打包数据
        const resultData = {
            totalScore: totalScore,
            factorScores: factorScores,
            date: new Date().toLocaleString() // 记录当前时间
        };

        // 4. 保存数据到浏览器缓存
        localStorage.setItem('scl90_results', JSON.stringify(resultData));
        
        // 5. 跳转到结果页 result.html
        window.location.href = 'result.html'; 
    }

    let myRadarChart = null;
    function drawChart(labels, data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        
        if(myRadarChart) myRadarChart.destroy(); // 如果已存在图表则销毁重绘

        myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: '因子分',
                    data: data,
                    backgroundColor: 'rgba(0, 86, 179, 0.2)',
                    borderColor: 'rgba(0, 86, 179, 1)',
                    pointBackgroundColor: 'rgba(0, 86, 179, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 1,
                        suggestedMax: 5,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }
</script>

</body>
</html>